<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimuNote - Simulateur de Validation de Semestre</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 0;
            color: #2d3748;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.98) 0%, rgba(26, 32, 44, 0.98) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 40px 60px;
            color: white;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-left p {
            font-size: 1.1em;
            opacity: 0.85;
            font-weight: 400;
            color: #e2e8f0;
        }

        .header-badge {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 30px;
            padding: 40px 60px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 30px 20px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .result-panel {
                position: relative !important;
                top: auto !important;
            }
            
            .header-left h1 {
                font-size: 1.8em;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 25px 15px;
            }
            
            .header-left h1 {
                font-size: 1.6em;
            }
            
            .header-left p {
                font-size: 0.95em;
            }
            
            .main-content {
                padding: 20px 15px;
            }
            
            .matiere-card {
                padding: 15px;
            }
            
            .matiere-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .matiere-header > div:last-child {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .evaluation-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .evaluation-item > div:last-child {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .moyenne-semestre {
                font-size: 2.5em;
            }
            
            .probability-value {
                font-size: 3em;
            }
        }

        .section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .section h2 {
            color: #1a202c;
            margin-bottom: 24px;
            font-size: 1.6em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .matiere-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%);
            border: 1px solid rgba(226, 232, 240, 0.6);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .matiere-card:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(203, 213, 225, 0.8);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .matiere-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .matiere-info h3 {
            color: #1a202c;
            font-size: 1.3em;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .matiere-info .coef {
            color: #64748b;
            font-size: 0.9em;
            font-weight: 500;
        }

        .matiere-moyenne {
            font-size: 1.8em;
            font-weight: 700;
            color: #2d3748;
        }

        .evaluation-item {
            background: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(226, 232, 240, 0.6);
            transition: all 0.2s ease;
        }

        .evaluation-item:hover {
            background: rgba(241, 245, 249, 0.9);
            border-color: rgba(203, 213, 225, 0.8);
        }

        .evaluation-info {
            flex: 1;
        }

        .evaluation-info .name {
            font-weight: 600;
            color: #1a202c;
            font-size: 1.05em;
        }

        .evaluation-info .coef {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 4px;
            font-weight: 500;
        }

        .evaluation-note {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1em;
            margin-right: 10px;
        }

        .btn {
            background: #2d3748;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(45, 55, 72, 0.15);
        }

        .btn:hover:not(:disabled) {
            background: #1a202c;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(45, 55, 72, 0.25);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: #dc3545;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.25);
        }

        .btn-secondary {
            background: #64748b;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.15);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #475569;
            box-shadow: 0 6px 20px rgba(100, 116, 139, 0.25);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #1a202c;
            font-weight: 600;
            font-size: 0.95em;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
            color: #1a202c;
        }

        .input-group input:focus {
            outline: none;
            border-color: #94a3b8;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            padding: 36px;
            border-radius: 24px;
            max-width: 540px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 64px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-header h3 {
            color: #1a202c;
            font-size: 1.6em;
            font-weight: 700;
        }

        .close-btn {
            background: #f1f5f9;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #64748b;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #e2e8f0;
            color: #1a202c;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .result-panel {
            position: sticky;
            top: 40px;
        }

        .result-card {
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.95) 0%, rgba(26, 32, 44, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: white;
            padding: 36px;
            border-radius: 24px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .result-card h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
            opacity: 0.85;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
            color: #e2e8f0;
        }

        .moyenne-semestre {
            font-size: 3.5em;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .moyenne-label {
            font-size: 1.2em;
            opacity: 0.8;
            font-weight: 500;
            color: #e2e8f0;
        }

        /* Couleurs dynamiques pour la moyenne selon le niveau */
        .moyenne-excellent {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .moyenne-bon {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.95) 0%, rgba(3, 105, 161, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(14, 165, 233, 0.3);
        }

        .moyenne-moyen {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95) 0%, rgba(217, 119, 6, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .moyenne-faible {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .moyenne-neutre {
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.95) 0%, rgba(26, 32, 44, 0.95) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .probability-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 32px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .probability-card h2 {
            margin-bottom: 0;
            color: #1a202c;
            font-weight: 700;
        }

        .probability-value {
            font-size: 4.5em;
            font-weight: 800;
            margin: 24px 0;
            line-height: 1;
            color: #1a202c;
        }

        .probability-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 28px 0;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d3748 0%, #1a202c 100%);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(45, 55, 72, 0.3);
        }

        .probability-message {
            padding: 24px;
            border-radius: 16px;
            margin-top: 24px;
            font-size: 1.05em;
            font-weight: 600;
            border: 2px solid;
        }

        .msg-excellent {
            background: #ecfdf5;
            color: #065f46;
            border-color: #10b981;
        }

        .msg-favorable {
            background: #f0f9ff;
            color: #075985;
            border-color: #0ea5e9;
        }

        .msg-incertain {
            background: #fffbeb;
            color: #92400e;
            border-color: #f59e0b;
        }

        .msg-risque {
            background: #fef2f2;
            color: #991b1b;
            border-color: #ef4444;
        }

        .msg-compromis {
            background: #fef2f2;
            color: #991b1b;
            border-color: #dc2626;
        }

        .add-btn {
            width: 100%;
            margin-top: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state p:first-of-type {
            font-size: 1.2em;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .settings-panel {
            background: rgba(248, 250, 252, 0.7);
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid rgba(226, 232, 240, 0.6);
        }

        .info-box {
            background: rgba(248, 250, 252, 0.9);
            backdrop-filter: blur(10px) saturate(150%);
            -webkit-backdrop-filter: blur(10px) saturate(150%);
            border-left: 4px solid #2d3748;
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 24px;
            font-size: 0.9em;
            line-height: 1.6;
            color: #475569;
            border: 1px solid rgba(226, 232, 240, 0.6);
        }

        .info-box strong {
            color: #1a202c;
            font-weight: 700;
        }

        .actions-row {
            display: flex;
            gap: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #2d3748;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .edit-inline {
            background: white;
            border: 2px solid #2d3748;
            border-radius: 10px;
            padding: 8px 14px;
            font-size: 1.05em;
            width: 90px;
            text-align: center;
            font-weight: 700;
            color: #2d3748;
            transition: all 0.2s ease;
        }

        .edit-inline:focus {
            outline: none;
            border-color: #1a202c;
            box-shadow: 0 0 0 4px rgba(45, 55, 72, 0.1);
        }

        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .quick-edit-hint {
            font-size: 0.9em;
            color: #64748b;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            font-weight: 500;
            border-left: 3px solid #cbd5e1;
        }

        .export-success {
            background: #ecfdf5;
            color: #065f46;
            padding: 14px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.4s ease;
            font-weight: 600;
            border: 2px solid #10b981;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        @media (max-width: 640px) {
            .toolbar {
                flex-direction: column;
            }
            
            .toolbar-group {
                width: 100%;
            }
            
            .toolbar-group .btn {
                flex: 1;
                justify-content: center;
            }
        }

        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==================== LOGIQUE M√âTIER ====================

        // Calcul de la moyenne d'une mati√®re
        function calculerMoyenneMatiere(evaluations) {
            if (!evaluations || evaluations.length === 0) return null;
            
            const sommeNotes = evaluations.reduce((acc, ev) => acc + (ev.note * ev.coefficient), 0);
            const sommeCoefs = evaluations.reduce((acc, ev) => acc + ev.coefficient, 0);
            
            return sommeCoefs > 0 ? sommeNotes / sommeCoefs : null;
        }

        // Calcul de la moyenne du semestre
        function calculerMoyenneSemestre(matieres) {
            if (!matieres || matieres.length === 0) return null;
            
            const matieresAvecMoyenne = matieres
                .map(m => ({ ...m, moyenne: calculerMoyenneMatiere(m.evaluations) }))
                .filter(m => m.moyenne !== null);
            
            if (matieresAvecMoyenne.length === 0) return null;
            
            const sommeNotes = matieresAvecMoyenne.reduce((acc, m) => acc + (m.moyenne * m.coefficient), 0);
            const sommeCoefs = matieresAvecMoyenne.reduce((acc, m) => acc + m.coefficient, 0);
            
            return sommeCoefs > 0 ? sommeNotes / sommeCoefs : null;
        }

        // G√©n√©ration des sc√©narios (optimis√© avec discr√©tisation)
        function genererScenarios(matieres, seuil = 10) {
            // Collecter toutes les √©valuations de toutes les mati√®res
            const toutesEvaluations = [];
            matieres.forEach(matiere => {
                matiere.evaluations.forEach(evaluation => {
                    toutesEvaluations.push({
                        matiereId: matiere.id,
                        matiereCoef: matiere.coefficient,
                        evaluationCoef: evaluation.coefficient,
                        noteEstimee: evaluation.note
                    });
                });
            });

            if (toutesEvaluations.length === 0) return { pourcentage: 0, total: 0, validants: 0 };

            // G√©n√©rer les plages de notes possibles (discr√©tisation)
            const plagesNotes = toutesEvaluations.map(ev => {
                const min = Math.max(0, ev.noteEstimee - 2);
                const max = Math.min(20, ev.noteEstimee + 2);
                const plage = [];
                for (let note = min; note <= max; note += 1) {
                    plage.push(note);
                }
                return plage;
            });

            // Calculer le nombre total de combinaisons
            const totalCombinaisons = plagesNotes.reduce((acc, plage) => acc * plage.length, 1);

            // SEUIL CRITIQUE : au-dessus de 1M de combinaisons, on passe en Monte Carlo
            const SEUIL_MONTE_CARLO = 1000000;

            if (totalCombinaisons > SEUIL_MONTE_CARLO) {
                console.log(`Trop de combinaisons (${totalCombinaisons.toLocaleString()}), passage en Monte Carlo`);
                return simulationMonteCarlo(matieres, seuil, 50000);
            }

            // G√©n√©ration exhaustive pour les petits cas
            let totalScenarios = 0;
            let scenariosValidants = 0;

            function genererRecursif(index, notesCourantes) {
                if (index === plagesNotes.length) {
                    const moyenneSemestre = calculerMoyenneAvecNotes(matieres, toutesEvaluations, notesCourantes);
                    totalScenarios++;
                    if (moyenneSemestre >= seuil) {
                        scenariosValidants++;
                    }
                    return;
                }

                for (const note of plagesNotes[index]) {
                    genererRecursif(index + 1, [...notesCourantes, note]);
                }
            }

            genererRecursif(0, []);

            const pourcentage = totalScenarios > 0 ? (scenariosValidants / totalScenarios) * 100 : 0;
            return { pourcentage, total: totalScenarios, validants: scenariosValidants };
        }

        // Calcul de moyenne avec des notes sp√©cifiques
        function calculerMoyenneAvecNotes(matieres, evaluations, notes) {
            const moyennesParMatiere = {};

            // Calculer les moyennes par mati√®re
            evaluations.forEach((ev, idx) => {
                if (!moyennesParMatiere[ev.matiereId]) {
                    moyennesParMatiere[ev.matiereId] = {
                        sommeNotes: 0,
                        sommeCoefs: 0,
                        coefMatiere: ev.matiereCoef
                    };
                }
                moyennesParMatiere[ev.matiereId].sommeNotes += notes[idx] * ev.evaluationCoef;
                moyennesParMatiere[ev.matiereId].sommeCoefs += ev.evaluationCoef;
            });

            // Calculer la moyenne du semestre
            let sommeSemestre = 0;
            let coefsSemestre = 0;

            Object.values(moyennesParMatiere).forEach(m => {
                if (m.sommeCoefs > 0) {
                    const moyenneMatiere = m.sommeNotes / m.sommeCoefs;
                    sommeSemestre += moyenneMatiere * m.coefMatiere;
                    coefsSemestre += m.coefMatiere;
                }
            });

            return coefsSemestre > 0 ? sommeSemestre / coefsSemestre : 0;
        }

        // Simulation Monte Carlo optimis√©e (pour grand nombre d'√©valuations)
        function simulationMonteCarlo(matieres, seuil, iterations = 50000) {
            const toutesEvaluations = [];
            matieres.forEach(matiere => {
                matiere.evaluations.forEach(evaluation => {
                    toutesEvaluations.push({
                        matiereId: matiere.id,
                        matiereCoef: matiere.coefficient,
                        evaluationCoef: evaluation.coefficient,
                        noteEstimee: evaluation.note
                    });
                });
            });

            let validants = 0;

            // Optimisation : pr√©-calculer les plages
            const plages = toutesEvaluations.map(ev => ({
                min: Math.max(0, ev.noteEstimee - 2),
                max: Math.min(20, ev.noteEstimee + 2)
            }));

            for (let i = 0; i < iterations; i++) {
                const notes = plages.map(p => Math.random() * (p.max - p.min) + p.min);
                const moyenne = calculerMoyenneAvecNotes(matieres, toutesEvaluations, notes);
                if (moyenne >= seuil) validants++;
            }

            const pourcentage = (validants / iterations) * 100;
            return { 
                pourcentage, 
                total: iterations, 
                validants,
                monteCarlo: true 
            };
        }

        // Interpr√©tation du r√©sultat
        function interpreterProbabilite(pourcentage) {
            if (pourcentage >= 80) {
                return {
                    message: "üéâ Semestre tr√®s probable !",
                    description: "Avec vos notes estim√©es, vous avez de tr√®s bonnes chances de valider.",
                    classe: "msg-excellent"
                };
            } else if (pourcentage >= 60) {
                return {
                    message: "‚úÖ Semestre favorable",
                    description: "La validation est probable, continuez sur cette lanc√©e !",
                    classe: "msg-favorable"
                };
            } else if (pourcentage >= 40) {
                return {
                    message: "‚ö†Ô∏è Semestre incertain",
                    description: "Le r√©sultat peut basculer dans un sens ou l'autre. Restez vigilant.",
                    classe: "msg-incertain"
                };
            } else if (pourcentage >= 20) {
                return {
                    message: "‚ö†Ô∏è Semestre √† risque",
                    description: "La validation est compromise. Il faut viser plus haut dans les prochaines √©valuations.",
                    classe: "msg-risque"
                };
            } else {
                return {
                    message: "‚ùå Semestre tr√®s compromis",
                    description: "La validation est hautement improbable avec ces estimations. Un effort important est n√©cessaire.",
                    classe: "msg-compromis"
                };
            }
        }

        // ==================== STOCKAGE LOCAL ====================

        const STORAGE_KEY = 'simunote_data';

        function sauvegarderDonnees(matieres, seuil) {
            const data = { matieres, seuil, version: '1.0', timestamp: Date.now() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function chargerDonnees() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    const parsed = JSON.parse(data);
                    return { matieres: parsed.matieres || [], seuil: parsed.seuil || 10 };
                }
            } catch (e) {
                console.error("Erreur chargement donn√©es", e);
            }
            return { matieres: [], seuil: 10 };
        }

        // ==================== IMPORT/EXPORT ====================

        function exporterDonnees(matieres, seuil) {
            const data = {
                version: '1.0',
                timestamp: Date.now(),
                seuil,
                matieres: matieres.map(m => ({
                    nom: m.nom,
                    coefficient: m.coefficient,
                    evaluations: m.evaluations.map(e => ({
                        nom: e.nom,
                        coefficient: e.coefficient,
                        note: e.note
                    }))
                }))
            };

            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `simunote-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importerDonnees(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validation basique
                    if (!data.matieres || !Array.isArray(data.matieres)) {
                        throw new Error('Format de fichier invalide');
                    }

                    // R√©assigner des IDs uniques
                    const matieres = data.matieres.map((m, idx) => ({
                        ...m,
                        id: Date.now() + idx,
                        evaluations: (m.evaluations || []).map((e, eidx) => ({
                            ...e,
                            id: Date.now() + idx * 1000 + eidx
                        }))
                    }));

                    callback({
                        matieres,
                        seuil: data.seuil || 10
                    });
                } catch (error) {
                    alert('Erreur lors de l\'import : fichier invalide ou corrompu');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // ==================== COMPOSANTS ====================

        function App() {
            const [matieres, setMatieres] = useState([]);
            const [seuil, setSeuil] = useState(10);
            const [showMatiereModal, setShowMatiereModal] = useState(false);
            const [showEvaluationModal, setShowEvaluationModal] = useState(false);
            const [matiereEnCours, setMatiereEnCours] = useState(null);
            const [calculating, setCalculating] = useState(false);
            const [exportSuccess, setExportSuccess] = useState(false);

            // Chargement initial
            useEffect(() => {
                const data = chargerDonnees();
                setMatieres(data.matieres);
                setSeuil(data.seuil);
            }, []);

            // Sauvegarde automatique
            useEffect(() => {
                if (matieres.length > 0 || seuil !== 10) {
                    sauvegarderDonnees(matieres, seuil);
                }
            }, [matieres, seuil]);

            // Calculs
            const moyenneSemestre = useMemo(() => calculerMoyenneSemestre(matieres), [matieres]);
            
            // D√©terminer la classe CSS selon la moyenne
            const moyenneClasse = useMemo(() => {
                if (moyenneSemestre === null) return 'moyenne-neutre';
                if (moyenneSemestre >= 16) return 'moyenne-excellent'; // Tr√®s bien
                if (moyenneSemestre >= 14) return 'moyenne-bon'; // Bien
                if (moyenneSemestre >= 10) return 'moyenne-moyen'; // Passable
                return 'moyenne-faible'; // Insuffisant
            }, [moyenneSemestre]);
            
            // Compter le nombre total d'√©valuations
            const totalEvaluations = useMemo(() => {
                return matieres.reduce((sum, m) => sum + m.evaluations.length, 0);
            }, [matieres]);
            
            const probabilite = useMemo(() => {
                if (!matieres.length) return null;
                setCalculating(true);
                const result = genererScenarios(matieres, seuil);
                setTimeout(() => setCalculating(false), 100);
                return result;
            }, [matieres, seuil]);

            const interpretation = probabilite ? interpreterProbabilite(probabilite.pourcentage) : null;

            // Actions mati√®res
            const ajouterMatiere = (matiere) => {
                setMatieres([...matieres, { ...matiere, id: Date.now(), evaluations: [] }]);
                setShowMatiereModal(false);
            };

            const modifierMatiere = (id, updates) => {
                setMatieres(matieres.map(m => m.id === id ? { ...m, ...updates } : m));
            };

            const supprimerMatiere = (id) => {
                if (confirm('Supprimer cette mati√®re et toutes ses √©valuations ?')) {
                    setMatieres(matieres.filter(m => m.id !== id));
                }
            };

            // Actions √©valuations
            const ajouterEvaluation = (matiereId, evaluation) => {
                setMatieres(matieres.map(m => 
                    m.id === matiereId 
                        ? { ...m, evaluations: [...m.evaluations, { ...evaluation, id: Date.now() }] }
                        : m
                ));
                setShowEvaluationModal(false);
                setMatiereEnCours(null);
            };

            const supprimerEvaluation = (matiereId, evaluationId) => {
                setMatieres(matieres.map(m => 
                    m.id === matiereId 
                        ? { ...m, evaluations: m.evaluations.filter(e => e.id !== evaluationId) }
                        : m
                ));
            };

            const modifierEvaluation = (matiereId, evaluationId, updates) => {
                setMatieres(matieres.map(m => 
                    m.id === matiereId 
                        ? { ...m, evaluations: m.evaluations.map(e => e.id === evaluationId ? { ...e, ...updates } : e) }
                        : m
                ));
            };

            // Import/Export
            const handleExport = () => {
                exporterDonnees(matieres, seuil);
                setExportSuccess(true);
                setTimeout(() => setExportSuccess(false), 3000);
            };

            const handleImportClick = () => {
                document.getElementById('file-import').click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (matieres.length > 0) {
                        if (!confirm('Importer ces donn√©es remplacera vos donn√©es actuelles. Continuer ?')) {
                            e.target.value = '';
                            return;
                        }
                    }
                    importerDonnees(file, (data) => {
                        setMatieres(data.matieres);
                        setSeuil(data.seuil);
                        e.target.value = '';
                    });
                }
            };

            const handleReset = () => {
                if (confirm('√ätes-vous s√ªr de vouloir effacer toutes vos donn√©es ?')) {
                    setMatieres([]);
                    setSeuil(10);
                    localStorage.removeItem(STORAGE_KEY);
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <div className="header-content">
                            <div className="header-left">
                                <h1>üéì SimuNote</h1>
                                <p>Simulateur de validation de semestre pour √©tudiants</p>
                            </div>
                            <div className="header-badge">
                                üîí 100% Local & Confidentiel
                            </div>
                        </div>
                    </div>

                    <div className="main-content">
                        <div>
                            <div className="section">
                                <h2>üìö Mes mati√®res</h2>
                                
                                {exportSuccess && (
                                    <div className="export-success">
                                        ‚úÖ Sauvegarde cr√©√©e avec succ√®s !
                                    </div>
                                )}

                                <div className="toolbar">
                                    <div className="toolbar-group">
                                        <button className="btn btn-small btn-icon" onClick={handleExport} disabled={matieres.length === 0}>
                                            üíæ Sauvegarder
                                        </button>
                                        <button className="btn btn-small btn-icon" onClick={handleImportClick}>
                                            üì§ Charger
                                        </button>
                                        <input 
                                            type="file" 
                                            id="file-import"
                                            accept=".json"
                                            onChange={handleImport}
                                            style={{display: 'none'}}
                                        />
                                    </div>
                                    <div className="toolbar-group">
                                        <button className="btn btn-small btn-secondary btn-icon" onClick={handleReset} disabled={matieres.length === 0}>
                                            üóëÔ∏è Tout effacer
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="settings-panel">
                                    <div className="input-group">
                                        <label>Seuil de validation du semestre</label>
                                        <input 
                                            type="number" 
                                            min="0" 
                                            max="20" 
                                            step="0.5"
                                            value={seuil}
                                            onChange={(e) => setSeuil(parseFloat(e.target.value) || 10)}
                                        />
                                    </div>
                                </div>

                                {matieres.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">üìñ</div>
                                        <p>Aucune mati√®re ajout√©e</p>
                                        <p style={{fontSize: '0.9em', color: '#999', marginTop: '10px'}}>
                                            Commencez par ajouter vos mati√®res et leurs √©valuations
                                        </p>
                                    </div>
                                ) : (
                                    <>
                                        <div className="quick-edit-hint">
                                            üí° Cliquez sur une note pour la modifier rapidement
                                        </div>
                                        {totalEvaluations > 12 && (
                                            <div style={{
                                                background: '#fff3cd',
                                                border: '2px solid #ffc107',
                                                padding: '12px',
                                                borderRadius: '8px',
                                                marginBottom: '15px',
                                                fontSize: '0.9em'
                                            }}>
                                                ‚ö° <strong>{totalEvaluations} √©valuations d√©tect√©es</strong> - La simulation utilise automatiquement 
                                                un √©chantillonnage Monte Carlo pour garantir des performances optimales.
                                            </div>
                                        )}
                                        {matieres.map(matiere => (
                                            <MatiereCard 
                                                key={matiere.id}
                                                matiere={matiere}
                                                onDelete={() => supprimerMatiere(matiere.id)}
                                                onAddEvaluation={() => {
                                                    setMatiereEnCours(matiere.id);
                                                    setShowEvaluationModal(true);
                                                }}
                                                onDeleteEvaluation={(evalId) => supprimerEvaluation(matiere.id, evalId)}
                                                onModifyEvaluation={(evalId, updates) => modifierEvaluation(matiere.id, evalId, updates)}
                                            />
                                        ))}
                                    </>
                                )}

                                <button className="btn add-btn" onClick={() => setShowMatiereModal(true)}>
                                    ‚ûï Ajouter une mati√®re
                                </button>
                            </div>
                        </div>

                        <div className="result-panel">
                            <div className={`result-card ${moyenneClasse}`}>
                                <h3>Moyenne du semestre</h3>
                                <div className="moyenne-semestre">
                                    {moyenneSemestre !== null ? moyenneSemestre.toFixed(2) : '--'}
                                </div>
                                <div className="moyenne-label">/ 20</div>
                            </div>

                            <div className="probability-card">
                                <h2 style={{marginBottom: '10px', color: '#333'}}>üéØ Probabilit√© de validation</h2>
                                
                                {calculating ? (
                                    <div className="loading">
                                        <div className="spinner"></div>
                                        <p>Calcul en cours...</p>
                                    </div>
                                ) : probabilite ? (
                                    <>
                                        <div className="probability-value" style={{
                                            color: probabilite.pourcentage >= 60 ? '#28a745' : 
                                                   probabilite.pourcentage >= 40 ? '#ffc107' : '#dc3545'
                                        }}>
                                            {probabilite.pourcentage.toFixed(1)}%
                                        </div>
                                        
                                        <div className="probability-bar">
                                            <div 
                                                className="probability-fill"
                                                style={{width: `${probabilite.pourcentage}%`}}
                                            />
                                        </div>

                                        {interpretation && (
                                            <div className={`probability-message ${interpretation.classe}`}>
                                                <div style={{fontSize: '1.2em', marginBottom: '10px'}}>
                                                    {interpretation.message}
                                                </div>
                                                <div style={{fontSize: '0.9em'}}>
                                                    {interpretation.description}
                                                </div>
                                            </div>
                                        )}

                                        <div className="info-box">
                                            <strong>M√©thodologie :</strong> {probabilite.monteCarlo ? 
                                                `√âchantillonnage Monte Carlo de ${probabilite.total.toLocaleString()} simulations al√©atoires` :
                                                `Simulation exhaustive de ${probabilite.total.toLocaleString()} sc√©narios`} avec une incertitude de ¬±2 points par note.
                                        </div>
                                    </>
                                ) : (
                                    <div style={{padding: '40px 20px', color: '#999'}}>
                                        <p>Ajoutez des mati√®res et des √©valuations pour voir la simulation</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {showMatiereModal && (
                        <MatiereModal 
                            onClose={() => setShowMatiereModal(false)}
                            onSave={ajouterMatiere}
                        />
                    )}

                    {showEvaluationModal && (
                        <EvaluationModal 
                            onClose={() => {
                                setShowEvaluationModal(false);
                                setMatiereEnCours(null);
                            }}
                            onSave={(evaluation) => ajouterEvaluation(matiereEnCours, evaluation)}
                        />
                    )}
                </div>
            );
        }

        function MatiereCard({ matiere, onDelete, onAddEvaluation, onDeleteEvaluation, onModifyEvaluation }) {
            const moyenne = calculerMoyenneMatiere(matiere.evaluations);

            const handleNoteChange = (evaluationId, newNote) => {
                const note = parseFloat(newNote);
                if (!isNaN(note) && note >= 0 && note <= 20) {
                    onModifyEvaluation(evaluationId, { note });
                }
            };

            return (
                <div className="matiere-card">
                    <div className="matiere-header">
                        <div className="matiere-info">
                            <h3>{matiere.nom}</h3>
                            <div className="coef">Coefficient : {matiere.coefficient}</div>
                        </div>
                        <div style={{display: 'flex', alignItems: 'center', gap: '15px'}}>
                            <div className="matiere-moyenne">
                                {moyenne !== null ? moyenne.toFixed(2) : '--'}
                            </div>
                            <button className="btn btn-danger btn-small" onClick={onDelete}>
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>

                    <div>
                        {matiere.evaluations.length === 0 ? (
                            <div style={{padding: '20px', textAlign: 'center', color: '#999'}}>
                                Aucune √©valuation
                            </div>
                        ) : (
                            matiere.evaluations.map(evaluation => (
                                <div key={evaluation.id} className="evaluation-item">
                                    <div className="evaluation-info">
                                        <div className="name">{evaluation.nom}</div>
                                        <div className="coef">Coef. {evaluation.coefficient}</div>
                                    </div>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                        <input 
                                            type="number"
                                            className="edit-inline"
                                            min="0"
                                            max="20"
                                            step="0.5"
                                            value={evaluation.note}
                                            onChange={(e) => handleNoteChange(evaluation.id, e.target.value)}
                                            onFocus={(e) => e.target.select()}
                                        />
                                        <span style={{color: '#999', fontSize: '0.9em'}}>/20</span>
                                        <button 
                                            className="btn btn-danger btn-small"
                                            onClick={() => onDeleteEvaluation(evaluation.id)}
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    <button className="btn btn-small add-btn" onClick={onAddEvaluation}>
                        ‚ûï Ajouter une √©valuation
                    </button>
                </div>
            );
        }

        function MatiereModal({ onClose, onSave }) {
            const [nom, setNom] = useState('');
            const [coefficient, setCoefficient] = useState(1);

            const handleSubmit = () => {
                if (!nom.trim()) {
                    alert('Veuillez entrer un nom de mati√®re');
                    return;
                }
                onSave({ nom, coefficient: parseFloat(coefficient) || 1 });
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Nouvelle mati√®re</h3>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="input-group">
                            <label>Nom de la mati√®re *</label>
                            <input 
                                type="text"
                                placeholder="Ex: Math√©matiques"
                                value={nom}
                                onChange={(e) => setNom(e.target.value)}
                                autoFocus
                            />
                        </div>

                        <div className="input-group">
                            <label>Coefficient</label>
                            <input 
                                type="number"
                                min="0.5"
                                step="0.5"
                                value={coefficient}
                                onChange={(e) => setCoefficient(e.target.value)}
                            />
                        </div>

                        <div className="modal-actions">
                            <button className="btn btn-secondary" onClick={onClose}>Annuler</button>
                            <button className="btn" onClick={handleSubmit}>Cr√©er</button>
                        </div>
                    </div>
                </div>
            );
        }

        function EvaluationModal({ onClose, onSave }) {
            const [nom, setNom] = useState('');
            const [coefficient, setCoefficient] = useState(1);
            const [note, setNote] = useState(10);

            const handleSubmit = () => {
                if (!nom.trim()) {
                    alert('Veuillez entrer un nom d\'√©valuation');
                    return;
                }
                const noteValue = parseFloat(note);
                if (isNaN(noteValue) || noteValue < 0 || noteValue > 20) {
                    alert('La note doit √™tre entre 0 et 20');
                    return;
                }
                onSave({ 
                    nom, 
                    coefficient: parseFloat(coefficient) || 1,
                    note: noteValue
                });
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Nouvelle √©valuation</h3>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>

                        <div className="input-group">
                            <label>Nom de l'√©valuation *</label>
                            <input 
                                type="text"
                                placeholder="Ex: Examen final"
                                value={nom}
                                onChange={(e) => setNom(e.target.value)}
                                autoFocus
                            />
                        </div>

                        <div className="form-row">
                            <div className="input-group">
                                <label>Coefficient</label>
                                <input 
                                    type="number"
                                    min="0.5"
                                    step="0.5"
                                    value={coefficient}
                                    onChange={(e) => setCoefficient(e.target.value)}
                                />
                            </div>

                            <div className="input-group">
                                <label>Note estim√©e (sur 20) *</label>
                                <input 
                                    type="number"
                                    min="0"
                                    max="20"
                                    step="0.5"
                                    value={note}
                                    onChange={(e) => setNote(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="info-box">
                            La simulation testera des notes entre <strong>{Math.max(0, note - 2)}</strong> et <strong>{Math.min(20, parseFloat(note) + 2)}</strong>
                        </div>

                        <div className="modal-actions">
                            <button className="btn btn-secondary" onClick={onClose}>Annuler</button>
                            <button className="btn" onClick={handleSubmit}>Ajouter</button>
                        </div>
                    </div>
                </div>
            );
        }

        // Rendu
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>